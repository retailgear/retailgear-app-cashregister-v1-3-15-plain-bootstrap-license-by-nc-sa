<!-- <app-supplier-product-slider [$data]="SupplierStockProductSliderData.asObservable()">
</app-supplier-product-slider> -->

<div class="card shadow-sm">
    <div class="card-header mt-5">
        <h3>{{ "TRANSACTION_DETAIL" | translate}} | {{transaction.sNumber}}</h3>
        <button type="button" class="btn btn-sm btn-secondary h-50" (click)="close(false)">
            <fa-icon [icon]="faTimes"></fa-icon>
        </button>
    </div>
    <div class="card-body row main m-0">
        <div class="col-md-4">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="fw-bolder mb-4">
                    <span>{{ "CUSTOMER" | translate }}</span>
                </h3>
                <ng-container *ngIf="from === 'transactions'">
                    <button class="btn btn-primary" (click)="openCustomer(transaction.oCustomer)">
                        {{ 'VIEW' | translate }}
                    </button>
                </ng-container>
            </div>
            <div class="row fw-bold gy-1">
                <div class="col-md-12">
                    <div class="text-gray-900 mt-2">{{ transaction?.oCustomer?.sFirstName }} {{
                        transaction?.oCustomer?.sPrefix}} {{ transaction?.oCustomer?.sLastName }} </div>
                </div>
                <div class="col-md-6">
                    <div class="mt-2 text-muted">{{ "INVOVICE_ADDRESS" | translate}}</div>
                    <div class="text-gray-800 mt-2">
                        <span> {{ transaction?.oCustomer?.oInvoiceAddress?.sStreet }} {{
                            transaction?.oCustomer?.oInvoiceAddress?.sHouseNumber }} </span>
                        <span> {{ transaction?.oCustomer?.oInvoiceAddress?.sPostalCode }} {{
                            transaction?.oCustomer?.oInvoiceAddress?.sCity }} </span>
                        <span> {{ transaction?.oCustomer?.oInvoiceAddress?.sCountry }}</span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mt-2 text-muted">{{ "SHIPPING_ADDRESS" | translate}}</div>
                    <div class="text-gray-800 mt-2">
                        <span> {{ transaction?.oCustomer?.oShippingAddress?.sStreet }} {{
                            transaction?.oCustomer?.oShippingAddress?.sHouseNumber }} </span>
                        <span> {{ transaction?.oCustomer?.oShippingAddress?.sPostalCode }} {{
                            transaction?.oCustomer?.oShippingAddress?.sCity }} </span>
                        <span> {{ transaction?.oCustomer?.oShippingAddress?.sCountry }}</span>
                    </div>
                </div>
                <div class="col-md-12">
                    <div class="text-gray-800 mt-2">{{ transaction?.oCustomer?.sEmail }}</div>
                    <div class="text-gray-800 mt-2">{{ transaction?.oCustomer?.sMobile }} &nbsp; &nbsp; {{
                        transaction?.oCustomer?.sLandLine }}</div>
                </div>
            </div>

            <div class="d-flex justify-content-between align-items-center">
              <h3 class="fw-bolder mb-4">
               <span>{{"CREATER_DETAIL" | translate}} </span>  
            </h3> 
            </div>

            <div class="row fw-bold gy-1">
            <div class="col-md-12">
                <div class="d-flex fs-6 ms-1 my-1">
                    <div class="align-items-center">                                 
                        <img alt="Logo"
                        *ngIf="transaction?.createrDetail?.sFirstName && (!transaction?.createrDetail?.sAvatar  || transaction?.createrDetail?.sAvatar == '')"
                        src="https://prismanote.com/public/prismanote.png" class="createrImage">
                      <img alt="Logo" *ngIf="transaction?.createrDetail?.sAvatar" [src]="transaction?.createrDetail?.sAvatar" class="createrImage">                                                      
                      <span> {{transaction?.createrDetail?.sFirstName || ''}} {{transaction?.createrDetail?.sLastName || ''}} </span>
                        </div>   
                        </div>        
            </div>
            </div>
        </div>
        <div class="col-md-8 row" *ngIf="eType === 'cash-register-revenue'">
            <h3 class="fw-bolder mb-4">
                <span>{{ "TRANSACTION_OVERVIEW" | translate }}</span>
            </h3>
            <div class="col-md-8 row fw-bold gy-1">
                <label class="col-md-4 mt-2 text-muted">{{"RECEIPT_NUMBER" | translate}}</label>
                <div class="col-md-8">
                    <div class="text-gray-800 mt-2">{{ transaction.sInvoiceNumber || '' }}</div>
                </div>
                <label class="col-md-4 mt-2 text-muted">{{"DATE_TIME" | translate}}</label>
                <div class="col-md-8">
                    <div class="text-gray-800 mt-2">{{ transaction.dCreatedDate }}</div>
                </div>
                <!-- <label class="col-md-4 mt-2 text-muted">{{"PAY_METHOD" | translate}}</label>
                <div class="col-md-8">
                    <div *ngFor="let payment of transaction.aPayments">
                        <div class="text-gray-800 mt-2">{{ payment.sMethod || '' }}</div>
                    </div>

                </div> -->
                <label class="col-md-4 mt-2 text-muted">{{"CHANGE" | translate}}</label>
                <div class="col-md-8">
                    <div class="text-gray-800 mt-2">{{ 0 }}</div>
                </div>
                <label class="col-md-4 mt-2 text-muted">{{"REFUNDED" | translate}}</label>
                <div class="col-md-8">
                    <div class="text-gray-800 mt-2">{{ 0 }}</div>
                </div>
                <label class="col-md-4 mt-2 text-muted">{{"ASSISTED_BY" | translate}}</label>
                <div class="col-md-8">
                    <div class="text-gray-800 mt-2">{{ transaction?.oEmployee?.sFirstName }} {{
                        transaction?.oEmployee?.sLastName }}</div>
                </div>
            </div>
            <div class="col-md-4">
                <button class="btn btn-sm btn-secondary w-100 d-flex">
                    <fa-icon [icon]="faFileInvoice"></fa-icon>
                    <label class="mx-auto">{{ "GENERAL_INVOICE" | translate}}</label>
                </button>
                <button [disabled]="!businessDetails?._id" class="btn btn-sm btn-secondary w-100 d-flex"
                    (click)="downloadWithVAT()">
                    <fa-icon [hidden]="downloadWithVATLoading" [icon]="faDownload"></fa-icon>
                    <span *ngIf="downloadWithVATLoading">
                        <i class="fa fa-spinner fa-spin" [hidden]="!downloadWithVATLoading" style="font-size:15px;"></i>
                    </span>
                    <label class="mx-auto">{{ "DOWNLOAD_WITH_VAT" | translate}}</label>
                </button>
                <button class="btn btn-sm btn-secondary w-100 d-flex" (click)="downloadWithVAT(true)">
                    <fa-icon [hidden]="printWithVATLoading" [icon]="faPrint"></fa-icon>
                    <span *ngIf="printWithVATLoading">
                        <i class="fa fa-spinner fa-spin" [hidden]="!printWithVATLoading" style="font-size:15px;"></i>
                    </span>
                    <label class="mx-auto">{{ "PRINT" | translate }}</label>
                </button>
                <button class="btn btn-sm btn-secondary w-100 d-flex">
                    <fa-icon [icon]="faDownload"></fa-icon>
                    <label class="mx-auto">{{ "DOWNLOAD_WITHOUT_VAT" | translate}}</label>
                </button>
                <button [disabled]="!businessDetails?._id" class="btn btn-sm btn-secondary w-100 d-flex" (click)="getThermalReceipt()">
                    <fa-icon [icon]="faReceipt"></fa-icon>
                    <label class="mx-auto"> {{ "THERMAL_RECEIPT" | translate}}</label>
                </button>
                <button class="btn btn-sm btn-secondary w-100 d-flex">
                    <fa-icon [icon]="faAt"></fa-icon>
                    <label class="mx-auto">{{ "MAIL" | translate}}</label>
                </button>
                <button class="btn btn-sm btn-secondary w-100 d-flex"
                    (click)="openTransaction(transaction, 'transaction')">
                    <fa-icon [icon]="faUndoAlt"></fa-icon>
                    <label class="mx-auto">{{"REFUND" | translate}}</label>
                </button>
                <button class="btn btn-sm btn-secondary w-100 d-flex">
                    <fa-icon [icon]="faClipboard"></fa-icon>
                    <label class="mx-auto">{{"VIEW_LOG" | translate}}</label>
                </button>
                <button class="btn btn-sm btn-secondary w-100 d-flex">
                    <fa-icon [icon]="faTrashAlt"></fa-icon>
                    <label class="mx-auto">{{ "DELETE" | translate}}</label>
                </button>
            </div>
        </div>
        <div class="col-md-8 row" *ngIf="eType === 'webshop-revenue' || eType === 'webshop-reservation'">
            <h3 class="fw-bolder mb-4">
                <span>{{ "OVERVIEW" | translate }}</span>
            </h3>
            <div class="col-md-8 row fw-bold gy-1">
                <div class="col-md-12">
                    <ng-select placeholder="Order status">
                        <ng-option>Status one</ng-option>
                        <ng-option>Status two</ng-option>
                        <ng-option>Status three</ng-option>
                        <ng-option>Status four</ng-option>
                    </ng-select>
                </div>
                <label class="col-md-4 mt-5 text-muted">{{"SHIPPING_METHOD" | translate}} : </label>
                <div class="col-md-8 mt-5">
                    <div class="text-gray-800">{{ "COMPLETED" | translate}}</div>
                </div>
                <button class="btn btn-sm btn-primary w-100 d-flex mt-5">
                    <label class="mx-auto">{{ "TRACK_AND_TRACE_ORDER" | translate}}</label>
                </button>
            </div>
            <div class="col-md-4">
                <button class="btn btn-sm btn-secondary w-100 d-flex">
                    <fa-icon [icon]="faDownload"></fa-icon>
                    <label class="mx-auto">{{ "RECEIPT" | translate}}</label>
                </button>
                <button class="btn btn-sm btn-secondary w-100 d-flex">
                    <fa-icon [icon]="faReceipt"></fa-icon>
                    <label class="mx-auto">{{"THERMAL_RECEIPT" | translate}}</label>
                </button>
                <button class="btn btn-sm btn-secondary w-100 d-flex">
                    <!-- <fa-icon [icon]="faAt"></fa-icon> -->
                    <label class="mx-auto"> {{ "EXCHANGE" | translate}}</label>
                </button>
                <button class="btn btn-sm btn-secondary w-100 d-flex" (click)="downloadWebOrder()">
                    <fa-icon [icon]="faDownload"></fa-icon>
                    <label class="mx-auto">{{ "DOWNLOAD_PDF" | translate}}</label>
                </button>
            </div>
        </div>
        <!-- </div> -->
        <div class="row">
            <div class="col-md-12">
                <h3 class="fw-bolder mb-3">
                    <span>{{ "ITEMS" | translate }}</span>
                </h3>
                <div class="row fw-bold gy-1 d-flex flex-wrap py-5">
                    <div class="flex-equal me-5">
                        <table class="table table-hover table-rounded table-striped border gy-7 gs-7">
                            <thead>
                                <tr class="fw-bold fs-6 text-gray-400">
                                    <td class="text-muted">{{'IMAGE' | translate}}</td>
                                    <td class="text-muted">{{'PRODUCT' | translate}}</td>
                                    <td class="text-muted">{{'PRICE' | translate}}</td>
                                    <td class="text-muted">{{'QUANTITY' | translate}}</td>
                                    <td class="text-muted" *ngIf="transaction.totalDiscount > 0">{{'DISCOUNT_PER_ITEM' | translate}}</td>
                                    <ng-container *ngIf="transaction.totalRedeemedLoyaltyPoints > 0">
                                        <td class="text-muted">{{'LOYALTY_POINTS_REDEEMED' | translate}}</td>
                                    </ng-container>
                                    <td class="text-muted"> {{'SAVING_POINTS' | translate}}</td>
                                    <td class="text-muted">{{'TAX' | translate}}</td>
                                    <td class="text-muted">{{'TOTAL_PRICE' | translate}}</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr *ngFor="let item of transaction.aTransactionItems">
                                    <td>
                                        <img src="{{ item.aImage[0] || imagePlaceHolder}}"
                                            (error)="item.aImage[0]=imagePlaceHolder" class="product_image">
                                    </td>
                                    <td>
                                        <div>
                                            {{ item.sArticleGroupName }} {{ item.sProductNumber }} <br />
                                            <!-- {{ item.sProductName }}   -->
                                            <span *ngIf="item.sDescription">{{ item.sDescription}} <br /></span>
                                            <span *ngIf="item?.totalPaymentAmount != item?.nPriceIncVatAfterDiscount">
                                                {{ 'ORIGINAL_AMOUNT_INC_DISC' | translate }}: {{ item.nPriceIncVatAfterDiscount }} <br />
                                            </span>
                                            
                                            <div *ngIf="item.related?.length">
                                                {{ "ALREADY_PAID" | translate}}:<br />
                                                {{item.sTransactionNumber}} | {{item.nPaymentAmount}} ({{"THIS_RECEIPT" | translate }})<br />
                                                <span *ngFor="let obj of item.related">{{obj.sTransactionNumber}} | {{obj.nRevenueAmount }}<br /></span>
                                            </div>
                                        </div>
                                        <div *ngIf="item?.aProductVariant?.length > 0">
                                            <div *ngFor="let variant of item.aProductVariant" class="d-flex">
                                                <div class="w-25">
                                                    {{ variant.sVariantBase }}
                                                </div> :
                                                <div class="w-50 px-2">
                                                    <span *ngIf="variant.sVariantBase !== 'color'"> {{ variant.value }}
                                                    </span>
                                                    <span *ngIf="variant.sVariantBase === 'color'"
                                                        [style.background]="variant.value"
                                                        class="px-2 border border-gray-600"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>{{item.nPriceIncVatAfterDiscount | currency: tillService.currency}}</td>
                                    <td>{{item.nQuantity}}</td>
                                    <td *ngIf="item.nDiscountToShow > 0">
                                        <span *ngIf="item.bDiscountOnPercentage">
                                            {{ item.nDiscount }}% ({{item.nDiscountToShow * item.nQuantity | currency: tillService.currency}})
                                        </span>
                                        <span *ngIf="!item.bDiscountOnPercentage">
                                            {{ item.nDiscountToShow * item.nQuantity | currency: tillService.currency}}
                                        </span>
                                    </td>
                                    <ng-container *ngIf="item.nRedeemedLoyaltyPoints > 0">
                                        <td>{{ item.nRedeemedLoyaltyPoints }} </td>
                                    </ng-container>
                                    <td>{{item.nSavingsPoints}} </td>
                                    <td>{{item.nVatRate}} % ({{item.vat || 0 | currency: tillService.currency }})</td>
                                    <td>
                                        <div class="d-flex align-items-center justify-content-between">
                                            <div>
                                                <span *ngIf="item.nDiscountToShow > 0">
                                                    <s>({{(item.nPriceIncVat * item.nQuantity) | currency: tillService.currency}})</s>
                                                </span>
                                                 {{item.totalPaymentAmount || 0 | currency: tillService.currency}}</div>
                                            <ng-container *ngIf="from != 'activity-details'">
                                                <div class="mx-2">
                                                    <div class="d-flex align-items-center">
                                                        <button class="btn btn-primary btn-sm"
                                                            (click)="showActivityItem(item,$event)">
                                                            <i class="fa fa-eye"></i>
                                                        </button>
                                                        <div *ngIf="item.bFetchingActivityItem"
                                                            class="spinner-border mx-2"></div>
                                                    </div>
                                                </div>
                                            </ng-container>
                                        </div>

                                    </td>
                                </tr>
                                <tr class="fw-bolder">
                                    <td></td>
                                    <td>{{ 'TOTAL' | translate }}</td>
                                    <td>{{ transaction.totalAfterDisc | currency: tillService.currency }}</td>
                                    <td>{{ transaction.nTotalQty }}</td>
                                    <td *ngIf="transaction.totalDiscount > 0">{{ transaction.totalDiscount | currency: tillService.currency }}</td>
                                    <ng-container *ngIf="transaction.totalRedeemedLoyaltyPoints > 0">
                                        <td>{{transaction.totalRedeemedLoyaltyPoints}}</td>
                                    </ng-container>
                                    <td>{{ transaction.totalSavingPoints }}</td>
                                    <td>{{ transaction.totalVat | currency: tillService.currency }}</td>
                                    <td>{{ transaction.total | currency: tillService.currency}}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="d-flex">
                    <h5 *ngIf='!transaction?.aTransactionItems?.length && !loading' style="text-align: center;">{{
                        'NO_DATA_FOUND' | translate }}</h5>
                    <div *ngIf="loading" class="spinner-border mx-auto"></div>
                </div>
            </div>
            <div class="col-md-4">
                <h3 class="fw-bolder mb-3">
                    <span>{{ "PAYMENTS" | translate }}</span>
                </h3>
                <div class="row fw-bold gy-1 d-flex flex-wrap py-5">
                    <div class="flex-equal me-5">
                        <table class="table table-hover table-rounded table-striped border gs-7">
                            <thead>
                                <tr class="fw-bold fs-6 text-gray-400">
                                    <td class="text-muted">{{'METHOD' | translate}}</td>
                                    <td class="text-muted">{{'AMOUNT' | translate}}</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr *ngFor="let item of transaction.aPayments">
                                    <td>{{item.sMethod}} <br/> ({{ item.dCreatedDate }})</td>
                                    <td>{{item.nAmount || 0}}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="card-footer">
        <button class="btn btn-secondary cancel ml-auto" (click)="close(false)">{{"TEXT_CANCEL" | translate}}</button>
    </div>
</div>
